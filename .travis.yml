os: windows
language: shell

install:
  # Install GraalVM with SDKMAN
  - choco install zip unzip
  - choco install visualstudio2017-workload-vctools
  - choco install ant
  - curl -sL "https://get.sdkman.io" | bash
  - mkdir -p "$HOME/.sdkman/etc/"
  - echo sdkman_auto_answer=true > "$HOME/.sdkman/etc/config"
  - echo sdkman_auto_selfupdate=true >> "$HOME/.sdkman/etc/config"
  - "source $HOME/.sdkman/bin/sdkman-init.sh"
  - sdk install java 20.0.0.r11-grl
  # Check if GraalVM was installed successfully
  - java -version
  # Install GraalVM Native Image
  - gu.cmd install native-image
  # Check if Native Image was installed properly
  - native-image.cmd --version

before_script: 
  - cd picocliExampleProject
  - mkdir lib
  - cd lib
  - wget https://repo1.maven.org/maven2/info/picocli/picocli/4.6.1/picocli-4.6.1.jar
  - cd ..

script: 
  - echo "building jar"
  - echo $(ant -version)
  - ant build
  - ./build.bat
  - echo "computing checksums"
  - cd executables
  - sha256sum primeDecomposition.jar > sha256sumJar.txt
  - sha256sum primeDecomposition.exe > sha256sumExe.txt

after_script:
  - cd ..
  - ls -R

before_deploy:
  - git config --local user.name "tboue"
  - git config --local user.email "theophane.boue@microej.com"
  - export TRAVIS_TAG=${TRAVIS_TAG:-$(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1)}
  - git tag $TRAVIS_TAG
  - echo "$TRAVIS_TAG"  

deploy:
  provider: releases
  api_key: 
     secure: $GITHUB_KEY 
  file_glob: true
  file: 
  - executables/**.exe
  - executables/**.jar
  - executables/**.txt
  skip_cleanup: true
  on:
    repo: tboue/testTravisCIPicocli
    branch: main
